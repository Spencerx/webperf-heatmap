<html>
    <head>
        <title>Web Performance Heatmap</title>
        <link rel="stylesheet" href="../css/main.css"/>
    </head>
    <body>
        <div class="container">
            <div id="heatmap-container">
            </div>
            <div id="heatmap-controls">
                <div id="heatmap-controls-labels">
                        <label id="heatmap-control-budget-label" for="heatmap-control-budget">Visual Budget: </label><br/>
                    <label id="heatmap-control-opacity-label" for="heatmap-control-opacity">Heatmap Opacity: </label><br/>
                    <label id="heatmap-control-gray-label" for="heatmap-control-gray">Screenshot Saturation: </label><br/>
                </div>
                <div id="heatmap-controls-sliders">
                    <input id="heatmap-control-budget" name="heatmap-control-budget" type="range" min="100" max="60000" step="100"></input>
                    <input id="heatmap-control-opacity" name="heatmap-control-opacity" type="range" min="0" max="1" step="0.01" value="0.95"></input>
                    <input id="heatmap-control-gray" name="heatmap-control-gray" type="range" min="0" max="100" step="10" value="10"></input>
                </div>
                <div id="heatmap-controls-values">
                        <span class="heatmap-control-value" id="heatmap-control-budget-value"></span><br/>
                    <span class="heatmap-control-value" id="heatmap-control-opacity-value"></span><br/>
                    <span class="heatmap-control-value" id="heatmap-control-gray-value"></span><br/>
                </div>
            </div>
        </div>
        <script>
            const getParameterByName = function(name, url) {
                if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                    results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, " "));
            }
            const loadImages = function () {
                let frameJSONurl = `../tests/${window.heatmap.testId}/frames.json`;
                fetch(frameJSONurl)
                    .then((response)=>{return response.json()})
                    .then((data)=>{
                        window.heatmap.frames = data;
                        renderFrames();
                        updateOpacity();
                        updateGrayscale();
                        updateBudget();
                })
            }
            const renderFrames = function() {
                var finalimg = document.createElement("img");
                finalimg.className="img-heatmap";
                finalimg.id = "img-heatmap-final-frame";
                finalimg.src = `../tests/${window.heatmap.testId}/final.jpg`;
                document.getElementById("heatmap-container").appendChild(finalimg);
                
                var heatmapOverlayContainer = document.createElement('div');
                heatmapOverlayContainer.id="heatmap-overlay-container";
                for (var i=window.heatmap.frames.length-1;i>=0;i--) {
                    var img = document.createElement("img");
                    img.className="img-heatmap img-heatmap-overlay";
                    img.id = `img-heatmap-overlay-${window.heatmap.frames[i].time}`
                    img.src = "../"+window.heatmap.frames[i].frame;
                    heatmapOverlayContainer.appendChild(img);
                }
                document.getElementById("heatmap-container").appendChild(heatmapOverlayContainer);
                updateColors();
            };

            const updateOpacity = function() {
                let opacity = document.getElementById('heatmap-control-opacity').value;
                document.getElementById("heatmap-overlay-container").style.opacity = opacity;
                document.getElementById("heatmap-control-opacity-value").innerHTML = `${parseInt(opacity*100)}%`;
            };
            const updateGrayscale = function() {
                let gray = 100-document.getElementById('heatmap-control-gray').value;
                document.getElementById("img-heatmap-final-frame").style.filter = `grayscale(${gray}%)`;
                document.getElementById("heatmap-control-gray-value").innerHTML = `${100-gray}%`;
            };
            const updateBudget = function() {
                window.heatmap.budget = parseInt(document.getElementById("heatmap-control-budget").value);
                document.getElementById("heatmap-control-budget-value").innerHTML = `${window.heatmap.budget.toLocaleString()}ms`;
                window.heatmap.maxTime = window.heatmap.budget;
                window.heatmap.minTime = window.heatmap.budget/2;
                updateColors();
            }

            const updateColors = function() {
                for (var i in window.heatmap.frames) {
                    var elem = document.getElementById(`img-heatmap-overlay-${window.heatmap.frames[i].time}`);
                    var hue = hueFromBudget(window.heatmap.budget,window.heatmap.frames[i].time);
                    elem.style.filter = `hue-rotate(${hue}deg) saturate(150%)`;
                }
            }
            const hueFromBudget = function(budget,time) {
                let maxHue = -60;
                let minHue = 60;
                if (time < window.heatmap.minTime) {
                    hue = minHue;
                } else if (time >= window.heatmap.maxTime) {
                    hue = maxHue;
                } else {
                    var f = (time-window.heatmap.minTime)/(window.heatmap.maxTime-window.heatmap.minTime);
                    hue = minHue - f * (minHue-maxHue);
                }
                return hue;
            }
            var live_updates = true;
            window.heatmap = {testId:null,frames:[]};
            window.heatmap.testId = getParameterByName('test');
            if (window.heatmap.testId==undefined) {
                alert("No test parameter provided, maybe a bad link?\nSending you back to the homepage.");
                window.location.href = window.location.href.substring(0,window.location.href.lastIndexOf("/")).replace("render","");
            }
            var budget = (getParameterByName('budget')==undefined?5000:getParameterByName('budget'));
            document.getElementById("heatmap-control-budget").value = parseInt(budget);
            var eventListenerType = (live_updates?'input':'change');
            document.getElementById("heatmap-control-opacity").addEventListener(eventListenerType,updateOpacity);
            document.getElementById("heatmap-control-gray").addEventListener(eventListenerType,updateGrayscale);
            document.getElementById("heatmap-control-budget").addEventListener(eventListenerType,updateBudget);
            loadImages();
        </script>
    </body>
</html>