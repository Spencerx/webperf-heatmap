<html>
    <head>
        <style>
            html, body {
                font-family: sans-serif;
            }
            .container {
                width:100%;
                padding: 5px;
                max-width:960px;
                margin:0 auto;
            }
            #heatmap-container {
                margin:5px;
                position:relative;
                top:0;
                left:0;
            }
            #heatmap-overlay-container {
                opacity:1;
            }
            .img-heatmap-overlay {
                position:absolute;
            }
            #img-heatmap-final-frame {
                filter: grayscale(90%);
            }
            .img-heatmap {
                top:0;
                left:0;
                width:100%;
            }
            input[type=range] {
                width:100%;
            }
            label {
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="heatmap-container">
            </div>
            <div id="heatmap-controls">
                <label for="heatmap-control-opacity">Heatmap Opacity: <span id="heatmap-control-opacity-value"></span></label>
                <input id="heatmap-control-opacity" name="heatmap-control-opacity" type="range" min="0" max="1" step="0.01" value="0.95"></input>
                <label for="heatmap-control-gray">Screenshot Saturation: <span id="heatmap-control-gray-value"></span></label>
                <input id="heatmap-control-gray" name="heatmap-control-gray" type="range" min="0" max="100" step="10" value="10"></input>
                <label for="heatmap-control-budget">Visual Budget: <span id="heatmap-control-budget-value"></span></label>
                <input id="heatmap-control-budget" name="heatmap-control-budget" type="range" min="100" max="60000" step="100" value=""></input>
            </div>
        </div>
        <script>
            const getParameterByName = function(name, url) {
                if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                    results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, " "));
            }
            const loadImages = function () {
                let frameJSONurl = `tests/${window.heatmap.testId}/frames.json`;
                fetch(frameJSONurl)
                    .then((response)=>{return response.json()})
                    .then((data)=>{
                        window.heatmap.frames = data;
                        renderFrames();
                        updateOpacity();
                        updateGrayscale();
                        updateBudget();
                })
            }
            const renderFrames = function() {
                var finalimg = document.createElement("img");
                finalimg.className="img-heatmap";
                finalimg.id = "img-heatmap-final-frame";
                finalimg.src = `tests/${window.heatmap.testId}/final.jpg`;
                document.getElementById("heatmap-container").appendChild(finalimg);
                
                var heatmapOverlayContainer = document.createElement('div');
                heatmapOverlayContainer.id="heatmap-overlay-container";
                for (var i=window.heatmap.frames.length-1;i>=0;i--) {
                    var img = document.createElement("img");
                    img.className="img-heatmap img-heatmap-overlay";
                    img.id = `img-heatmap-overlay-${window.heatmap.frames[i].time}`
                    img.src = window.heatmap.frames[i].frame;
                    heatmapOverlayContainer.appendChild(img);
                }
                document.getElementById("heatmap-container").appendChild(heatmapOverlayContainer);
                updateColors();
            };

            const updateOpacity = function() {
                let opacity = document.getElementById('heatmap-control-opacity').value;
                document.getElementById("heatmap-overlay-container").style.opacity = opacity;
                document.getElementById("heatmap-control-opacity-value").innerHTML = `${parseInt(opacity*100)}%`;
            };
            const updateGrayscale = function() {
                let gray = 100-document.getElementById('heatmap-control-gray').value;
                document.getElementById("img-heatmap-final-frame").style.filter = `grayscale(${gray}%)`;
                document.getElementById("heatmap-control-gray-value").innerHTML = `${100-gray}%`;
            };
            const updateBudget = function() {
                window.heatmap.budget = parseInt(document.getElementById("heatmap-control-budget").value);
                document.getElementById("heatmap-control-budget-value").innerHTML = `${window.heatmap.budget.toLocaleString()}ms`;
                window.heatmap.maxTime = window.heatmap.budget;
                window.heatmap.minTime = window.heatmap.budget/2;
                updateColors();
            }

            const updateColors = function() {
                for (var i in window.heatmap.frames) {
                    var elem = document.getElementById(`img-heatmap-overlay-${window.heatmap.frames[i].time}`);
                    var hue = hueFromBudget(window.heatmap.budget,window.heatmap.frames[i].time);
                    elem.style.filter = `hue-rotate(${hue}deg) saturate(150%)`;
                }
            }
            const hueFromBudget = function(budget,time) {
                let maxHue = -60;
                let minHue = 60;
                if (time < window.heatmap.minTime) {
                    hue = minHue;
                } else if (time >= window.heatmap.maxTime) {
                    hue = maxHue;
                } else {
                    var f = (time-window.heatmap.minTime)/(window.heatmap.maxTime-window.heatmap.minTime);
                    hue = minHue - f * (minHue-maxHue);
                }
                console.log(time,window.heatmap.minTime,window.heatmap.maxTime,hue);
                
                return hue;
            }
            var live_updates = true;
            window.heatmap = {testId:null,frames:[]};
            window.heatmap.testId = getParameterByName('test');
            var budget = getParameterByName('budget');
            if (budget !== undefined) {
                document.getElementById("heatmap-control-budget").value = parseInt(budget);
            }
            var eventListenerType = (live_updates?'input':'change');
            document.getElementById("heatmap-control-opacity").addEventListener(eventListenerType,updateOpacity);
            document.getElementById("heatmap-control-gray").addEventListener(eventListenerType,updateGrayscale);
            document.getElementById("heatmap-control-budget").addEventListener(eventListenerType,updateBudget);
            loadImages();
        </script>
    </body>
</html>